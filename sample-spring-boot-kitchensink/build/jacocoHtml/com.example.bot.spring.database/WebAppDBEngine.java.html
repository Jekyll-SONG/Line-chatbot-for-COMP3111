<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>WebAppDBEngine.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sample-spring-boot-kitchensink</a> &gt; <a href="index.source.html" class="el_package">com.example.bot.spring.database</a> &gt; <span class="el_source">WebAppDBEngine.java</span></div><h1>WebAppDBEngine.java</h1><pre class="source lang-java linenums">package com.example.bot.spring.database;

import java.net.URISyntaxException;
import java.sql.Connection;
import java.sql.Date;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.text.DateFormat;
import java.text.SimpleDateFormat;
import java.util.Calendar;
import java.util.GregorianCalendar;
import java.util.LinkedList;

import com.example.bot.spring.webapplication.domain.*;

/**
 * this is the DBEngine that display the information on the website page
 * @author jsongaf
 *
 */
<span class="fc" id="L22">public class WebAppDBEngine extends DBEngine {</span>
	
<span class="fc" id="L24">	static final DateFormat df = new SimpleDateFormat(&quot;yyyy-MM-dd&quot;);</span>
	
	private Connection connection;
	/**
	 * get the customers information from the databse
	 * @return
	 * @throws Exception
	 */
	public LinkedList&lt;Customer&gt; getAllCustomerInfo() throws Exception{
<span class="fc" id="L33">		connection = this.getConnection();</span>
<span class="fc" id="L34">		LinkedList&lt;Customer&gt; allCus = new LinkedList&lt;Customer&gt;();</span>
		PreparedStatement nstmt;
<span class="fc" id="L36">		nstmt = connection.prepareStatement(</span>
				&quot;SELECT * &quot;
				+ &quot; FROM customer_info&quot;);
<span class="fc" id="L39">		ResultSet rs = nstmt.executeQuery();</span>
<span class="fc" id="L40">		int idx = 1;</span>
<span class="fc bfc" id="L41" title="All 2 branches covered.">		while(rs.next()) {</span>
<span class="fc" id="L42">			Customer cus = new Customer();</span>
<span class="fc" id="L43">			String name = rs.getString(2);</span>
<span class="fc" id="L44">			String phone = rs.getString(3);</span>
<span class="fc" id="L45">			String bootableid = rs.getString(5);</span>
<span class="fc" id="L46">			int adults = rs.getInt(6);</span>
<span class="fc" id="L47">			int children = rs.getInt(7);</span>
<span class="fc" id="L48">			int toddler = rs.getInt(8);</span>
<span class="fc" id="L49">			double totalPrice = rs.getDouble(9);</span>
<span class="fc" id="L50">			double pricePaid = rs.getDouble(10);</span>
<span class="fc" id="L51">			String special = rs.getString(11);</span>
<span class="fc" id="L52">			cus.setIdx(idx);</span>
<span class="fc" id="L53">			cus.setAdults(adults);</span>
<span class="fc" id="L54">			cus.setBootableId(bootableid);</span>
<span class="fc" id="L55">			cus.setChildren(children);</span>
<span class="fc" id="L56">			cus.setName(name);</span>
<span class="fc" id="L57">			cus.setPhone(phone);</span>
<span class="fc" id="L58">			cus.setSpecial(special);</span>
<span class="fc" id="L59">			cus.setToddler(toddler);</span>
<span class="fc" id="L60">			cus.setPricePaid(pricePaid);</span>
<span class="fc" id="L61">			cus.setTotalPrice(totalPrice);</span>
<span class="fc" id="L62">			allCus.add(cus);</span>
<span class="fc" id="L63">			idx++;</span>
<span class="fc" id="L64">		}</span>
<span class="fc" id="L65">		nstmt.close();</span>
<span class="fc" id="L66">		rs.close();</span>
<span class="fc" id="L67">		connection.close();</span>
<span class="fc" id="L68">		connection = null;</span>
<span class="fc" id="L69">		return allCus;</span>
	}
	/**
	 * get the tours information from the database
	 * @return
	 * @throws Exception
	 */
	public LinkedList&lt;Tour&gt; getAllTourInfo() throws Exception{
<span class="fc" id="L77">		connection = this.getConnection();</span>
<span class="fc" id="L78">		LinkedList&lt;Tour&gt; allTours = new LinkedList&lt;Tour&gt;();</span>
		PreparedStatement nstmt;
<span class="fc" id="L80">			nstmt = connection.prepareStatement(</span>
					&quot;SELECT  b.bootableid, i.tour_name, b.tourdate, b.tourguideid, b.hotel, b.tourcapcity, b.registerednum, b.mintourist&quot;
					+ &quot; FROM booking_table b, tour_touroffer_relation o, tour_info i &quot;
					+ &quot; WHERE b.bootableid = o.bootableid&quot;
					+ &quot; AND i.tourid = o.tourid&quot;);
<span class="fc" id="L85">			ResultSet rs = nstmt.executeQuery();</span>
<span class="fc bfc" id="L86" title="All 2 branches covered.">			while(rs.next()) {</span>
<span class="fc" id="L87">				Tour tour = new Tour();</span>
<span class="fc" id="L88">				String tourId = rs.getString(1);</span>
<span class="fc" id="L89">				String tourName = rs.getString(2);</span>
<span class="fc" id="L90">				String tourDate = rs.getString(3);</span>
<span class="fc" id="L91">				int tourGuideId = rs.getInt(4);</span>
<span class="fc" id="L92">				String nameOfHotel = rs.getString(5);</span>
<span class="fc" id="L93">				int tourCapacity = rs.getInt(6);</span>
<span class="fc" id="L94">				int registeredNum = rs.getInt(7);</span>
<span class="fc" id="L95">				int minTourist = rs.getInt(8);</span>
<span class="fc" id="L96">				tour.setNameOfHotel(nameOfHotel);</span>
<span class="fc" id="L97">				tour.setRegisteredNum(registeredNum);</span>
<span class="fc" id="L98">				tour.setTourCapacity(tourCapacity);</span>
<span class="fc" id="L99">				tour.setTourDate(tourDate);</span>
<span class="fc" id="L100">				tour.setTourGuideId(tourGuideId);</span>
<span class="fc" id="L101">				tour.setTourId(tourId);</span>
<span class="fc" id="L102">				tour.setTourName(tourName);</span>
<span class="fc" id="L103">				tour.setMinTourist(minTourist);</span>
<span class="fc" id="L104">				allTours.add(tour);</span>
<span class="fc" id="L105">			}</span>
<span class="fc" id="L106">			nstmt.close();</span>
<span class="fc" id="L107">			rs.close();</span>
<span class="fc" id="L108">			connection.close();</span>
<span class="fc" id="L109">			connection = null;</span>
<span class="fc" id="L110">		return allTours;</span>
	}
	/**
	 * add a new customer in the website if needed
	 * @param customer
	 * @throws Exception
	 */
	public void addNewCustomer(Customer customer) throws Exception {
<span class="nc" id="L118">		connection = this.getConnection();</span>
<span class="nc" id="L119">		String name = customer.getName();</span>
<span class="nc" id="L120">		String phone = customer.getPhone();</span>
<span class="nc" id="L121">		String bootableid = customer.getBootableId();</span>
<span class="nc" id="L122">		int adults = customer.getAdults();</span>
<span class="nc" id="L123">		int children = customer.getChildren();</span>
<span class="nc" id="L124">		int toddler = customer.getToddler();</span>
<span class="nc" id="L125">		String special = customer.getSpecial();</span>
<span class="nc" id="L126">		PreparedStatement nstmt = null;</span>
<span class="nc" id="L127">		double price = 0;</span>
<span class="nc" id="L128">		String field = null;</span>
<span class="nc" id="L129">		String ts = bootableid.substring(5);</span>
<span class="nc" id="L130">		String id = bootableid.substring(0, 5);</span>
<span class="nc" id="L131">		int year = Integer.parseInt(ts.substring(0, 4));</span>
<span class="nc" id="L132">		int month = Integer.parseInt(ts.substring(4, 6));</span>
<span class="nc" id="L133">		int day = Integer.parseInt(ts.substring(6, 8));</span>
<span class="nc" id="L134">		Calendar cal = new GregorianCalendar(year, month - 1, day);</span>
<span class="nc" id="L135">		int dayOfWeek = cal.get(Calendar.DAY_OF_WEEK);</span>
<span class="nc bnc" id="L136" title="All 4 branches missed.">		if(Calendar.SUNDAY == dayOfWeek || Calendar.SATURDAY == dayOfWeek) {</span>
<span class="nc" id="L137">			field = &quot;weekend_price&quot;;</span>
		}else {
<span class="nc" id="L139">		   	field = &quot;weekday_price&quot;;</span>
		}
<span class="nc" id="L141">		nstmt = connection.prepareStatement(</span>
				&quot;SELECT &quot;+field
				+ &quot; FROM tour_price&quot;
				+ &quot; WHERE tourid = ?&quot;);
<span class="nc" id="L145">		nstmt.setString(1, id);</span>
<span class="nc" id="L146">		ResultSet rs = nstmt.executeQuery();</span>
<span class="nc bnc" id="L147" title="All 2 branches missed.">		while(rs.next()) {</span>
<span class="nc" id="L148">			price = rs.getDouble(1);</span>
		}
<span class="nc" id="L150">		rs.close();</span>
<span class="nc" id="L151">		nstmt.close();</span>
<span class="nc" id="L152">		double totalPrice = price*adults+price*0.8*children;</span>
<span class="nc" id="L153">		nstmt = connection.prepareStatement(</span>
				&quot;SELECT&quot;);
<span class="nc" id="L155">		nstmt = connection.prepareStatement(</span>
				&quot;INSERT INTO customer_info&quot;
				+ &quot; VALUES (0,?,?,0,?,?,?,?,?,0,?) &quot;);
<span class="nc" id="L158">		nstmt.setString(1, name);</span>
<span class="nc" id="L159">		nstmt.setString(2, phone);</span>
<span class="nc" id="L160">		nstmt.setString(3,bootableid);</span>
<span class="nc" id="L161">		nstmt.setInt(4, adults);</span>
<span class="nc" id="L162">		nstmt.setInt(5, children);</span>
<span class="nc" id="L163">		nstmt.setInt(6, toddler);</span>
<span class="nc" id="L164">		nstmt.setDouble(7, totalPrice);</span>
<span class="nc" id="L165">		nstmt.setString(8, special);</span>
<span class="nc" id="L166">		nstmt.execute();</span>
<span class="nc" id="L167">		nstmt.close();</span>
<span class="nc" id="L168">		connection.close();</span>
<span class="nc" id="L169">		connection = null;</span>
<span class="nc" id="L170">	}</span>
	/**
	 * get unanswered questions about the database to display it on the website
	 * @return
	 * @throws Exception
	 */
	public LinkedList&lt;UQ&gt;getUQs() throws Exception{
<span class="fc" id="L177">		connection = this.getConnection();</span>
		PreparedStatement stmt;
		ResultSet rs;
<span class="fc" id="L180">		LinkedList&lt;UQ&gt; result = new LinkedList&lt;UQ&gt;(); </span>
		
<span class="fc" id="L182">		String statement = &quot;SELECT * FROM unanswered_question &quot;;</span>
<span class="fc" id="L183">		stmt = connection.prepareStatement(statement);</span>
<span class="fc" id="L184">		rs = stmt.executeQuery();	</span>
<span class="fc" id="L185">		int idx = 1;</span>
<span class="fc bfc" id="L186" title="All 2 branches covered.">		while (rs.next()) {</span>
<span class="fc" id="L187">			String id = rs.getString(1); </span>
<span class="fc" id="L188">			String question = rs.getString(2);</span>
<span class="fc" id="L189">			boolean answered = rs.getBoolean(3);</span>
<span class="pc bpc" id="L190" title="1 of 2 branches missed.">			if(!answered) {</span>
<span class="fc" id="L191">				UQ uq = new UQ();</span>
<span class="fc" id="L192">				uq.setIdx(idx);</span>
<span class="fc" id="L193">				uq.setId(id);</span>
<span class="fc" id="L194">				uq.setQuestion(question);</span>
<span class="fc" id="L195">				result.add(uq);</span>
<span class="fc" id="L196">				idx++;</span>
			}
<span class="fc" id="L198">		}</span>
		
<span class="fc" id="L200">		rs.close();</span>
<span class="fc" id="L201">		stmt.close();</span>
<span class="fc" id="L202">		connection.close();</span>
<span class="fc" id="L203">		connection = null;</span>
<span class="fc" id="L204">		return result;</span>
	}
	/**
	 * answer the unanswered question from the website
	 * @param question
	 * @param id
	 * @param answer
	 * @throws Exception
	 */
	public void answerUQ(String question, String id, String answer) throws Exception {
<span class="nc" id="L214">		connection = this.getConnection();</span>
		PreparedStatement nstmt;
<span class="nc" id="L216">		nstmt = connection.prepareStatement(</span>
				&quot;UPDATE unanswered_question&quot;
				+ &quot; SET answer = ?, answered_or_not = true&quot;
				+ &quot; WHERE id = ? AND question = ?&quot;);
	
<span class="nc" id="L221">		nstmt.setString(1, answer);</span>
<span class="nc" id="L222">		nstmt.setString(2, id);</span>
<span class="nc" id="L223">		nstmt.setString(3, question);</span>
<span class="nc" id="L224">		nstmt.executeUpdate();</span>
<span class="nc" id="L225">		nstmt.close();</span>
<span class="nc" id="L226">		connection.close();</span>
<span class="nc" id="L227">		connection = null;</span>
<span class="nc" id="L228">	}</span>
	/**
	 * get the general tour information from the database and display
	 * @return
	 * @throws Exception
	 */
	public LinkedList&lt;Tour&gt; getGeneralTourInfo() throws Exception {
<span class="fc" id="L235">		connection = this.getConnection();</span>
		PreparedStatement stmt;
		ResultSet rs;
<span class="fc" id="L238">		LinkedList&lt;Tour&gt; result = new LinkedList&lt;Tour&gt;(); </span>
<span class="fc" id="L239">		String statement = &quot;SELECT DISTINCT tourid, tour_name FROM tour_info&quot;;</span>
<span class="fc" id="L240">		stmt = connection.prepareStatement(statement);</span>
<span class="fc" id="L241">		rs = stmt.executeQuery();			</span>
<span class="fc bfc" id="L242" title="All 2 branches covered.">		while (rs.next()) {</span>
<span class="fc" id="L243">			String tourId = rs.getString(1); </span>
<span class="fc" id="L244">			String name = rs.getString(2);</span>
<span class="fc" id="L245">			Tour tour = new Tour();</span>
<span class="fc" id="L246">			tour.setTourId(tourId);</span>
<span class="fc" id="L247">			tour.setTourName(name);</span>
<span class="fc" id="L248">			result.add(tour);</span>
<span class="fc" id="L249">		}</span>
		
<span class="fc" id="L251">		rs.close();</span>
<span class="fc" id="L252">		stmt.close();</span>
<span class="fc" id="L253">		connection.close();</span>
<span class="fc" id="L254">		connection = null;</span>
<span class="fc" id="L255">		return result;</span>
	}
	/**
	 * add a new tour in the webstie
	 * @param tour
	 * @throws Exception
	 */
	public void addNewTour(Tour tour) throws Exception{
<span class="nc" id="L263">		connection = this.getConnection();</span>
<span class="nc" id="L264">		PreparedStatement nstmt = connection.prepareStatement(</span>
				&quot;INSERT INTO booking_table&quot;
				+ &quot; VALUES (?,?,?,?,?,?,0,'unconfirmed',0)&quot;);
<span class="nc" id="L267">		String tourId = tour.getTourId();</span>
<span class="nc" id="L268">		String date = tour.getTourDate();</span>
		
<span class="nc" id="L270">		String yyyy = date.substring(0, 4);</span>
<span class="nc" id="L271">		String mm = date.substring(5,7);</span>
<span class="nc" id="L272">		String dd = date.substring(8);</span>
<span class="nc" id="L273">		String bootableid = tourId +yyyy+mm+dd;</span>
<span class="nc" id="L274">		int tourGuideId = tour.getTourGuideId();</span>
<span class="nc" id="L275">		String nameOfHotel = tour.getNameOfHotel();</span>
<span class="nc" id="L276">		int tourCapacity = tour.getTourCapacity();</span>
<span class="nc" id="L277">		int minTourist = tour.getMinTourist();</span>
<span class="nc" id="L278">		nstmt.setString(1, bootableid);</span>
<span class="nc" id="L279">		nstmt.setDate(2, new java.sql.Date(df.parse(date).getTime()));</span>
<span class="nc" id="L280">		nstmt.setInt(3,tourGuideId);</span>
<span class="nc" id="L281">		nstmt.setString(4,nameOfHotel);</span>
<span class="nc" id="L282">		nstmt.setInt(5, tourCapacity);</span>
<span class="nc" id="L283">		nstmt.setInt(6, minTourist);</span>
<span class="nc" id="L284">		nstmt.execute();</span>
<span class="nc" id="L285">		nstmt.close();</span>
<span class="nc" id="L286">		nstmt = connection.prepareStatement(</span>
				&quot;INSERT INTO tour_touroffer_relation&quot;
				+ &quot; VALUES (?,?)&quot;);
<span class="nc" id="L289">		nstmt.setString(1, tourId);</span>
<span class="nc" id="L290">		nstmt.setString(2, bootableid);</span>
<span class="nc" id="L291">		nstmt.execute();</span>
<span class="nc" id="L292">		nstmt.close();</span>
<span class="nc" id="L293">		connection.close();</span>
<span class="nc" id="L294">		connection = null;</span>
<span class="nc" id="L295">	}</span>
	/**
	 * get the discount activities for Double Eleven
	 * @return
	 * @throws Exception
	 */
	public LinkedList&lt;Activity&gt; getAllActivities() throws Exception{
		// TODO Auto-generated method stub
<span class="fc" id="L303">		connection = this.getConnection();</span>
		PreparedStatement stmt;
		ResultSet rs;
<span class="fc" id="L306">		LinkedList&lt;Activity&gt; result = new LinkedList&lt;Activity&gt;(); </span>
<span class="fc" id="L307">		String statement = &quot;SELECT * FROM double11&quot;;</span>
<span class="fc" id="L308">		stmt = connection.prepareStatement(statement);</span>
<span class="fc" id="L309">		rs = stmt.executeQuery();			</span>
<span class="pc bpc" id="L310" title="1 of 2 branches missed.">		while (rs.next()) {</span>
<span class="nc" id="L311">			String bootableid = rs.getString(1); </span>
<span class="nc" id="L312">			int quota = rs.getInt(2);</span>
<span class="nc" id="L313">			Activity activity = new Activity();</span>
<span class="nc" id="L314">			activity.setBootableId(bootableid);</span>
<span class="nc" id="L315">			activity.setQuota(quota);</span>
<span class="nc" id="L316">			result.add(activity);</span>
<span class="nc" id="L317">		}</span>
<span class="fc" id="L318">		rs.close();</span>
<span class="fc" id="L319">		stmt.close();</span>
<span class="fc" id="L320">		connection.close();</span>
<span class="fc" id="L321">		connection = null;</span>
<span class="fc" id="L322">		return result;</span>
	}
	/**
	 * create a discount event for Double Eleven
	 * @param act
	 * @throws Exception
	 */
	public void createNewActivity(Activity act) throws Exception{
		// TODO Auto-generated method stub
<span class="nc" id="L331">		connection = this.getConnection();</span>
<span class="nc" id="L332">		String bootableid = act.getBootableId();</span>
<span class="nc" id="L333">		int quota = act.getQuota();</span>
<span class="nc" id="L334">		PreparedStatement nstmt = connection.prepareStatement(</span>
				&quot;INSERT INTO double11&quot;
				+ &quot; VALUES (?,?,?,'released')&quot;);
<span class="nc" id="L337">		nstmt.setString(1, bootableid);</span>
<span class="nc" id="L338">		nstmt.setInt(2, quota);</span>
<span class="nc" id="L339">		nstmt.setInt(3, quota);</span>
<span class="nc" id="L340">		nstmt.execute();</span>
<span class="nc" id="L341">		nstmt.close();</span>
<span class="nc" id="L342">		connection.close();</span>
<span class="nc" id="L343">		connection = null;</span>
<span class="nc" id="L344">	}</span>
	/**
	 * update the Customer information on whether he could get a discount
	 * @param customer
	 * @throws Exception
	 */
	public void updateCustomer(Customer customer) throws Exception{
<span class="nc" id="L351">		connection = this.getConnection();</span>
<span class="nc" id="L352">		String bootableid = customer.getBootableId();</span>
<span class="nc" id="L353">		String name = customer.getName();</span>
<span class="nc" id="L354">		double pricePaid = customer.getPricePaid();</span>
<span class="nc" id="L355">		double tourFee = customer.getTotalPrice();</span>
<span class="nc" id="L356">		int people = customer.getAdults()+customer.getChildren()+customer.getToddler();</span>
<span class="nc" id="L357">		PreparedStatement nstmt = connection.prepareStatement(</span>
				&quot;UPDATE customer_info&quot;
				+ &quot; SET paidamount = ?&quot;
				+ &quot; WHERE customername = ? AND bootableid = ?&quot;);
<span class="nc" id="L361">		nstmt.setDouble(1, pricePaid);</span>
<span class="nc" id="L362">		nstmt.setString(2, name);</span>
<span class="nc" id="L363">		nstmt.setString(3, bootableid);</span>
<span class="nc" id="L364">		nstmt.execute();</span>
<span class="nc" id="L365">		nstmt.close();</span>
<span class="nc bnc" id="L366" title="All 2 branches missed.">		if(tourFee &lt;= pricePaid) {</span>
<span class="nc" id="L367">			nstmt = connection.prepareStatement(</span>
					&quot;UPDATE booking_table&quot;
					+&quot; SET paidnum = paidnum + ?&quot;
					+&quot; WHERE bootableid = ?&quot;);
<span class="nc" id="L371">			nstmt.setInt(1, people);</span>
<span class="nc" id="L372">			nstmt.setString(2, bootableid);</span>
<span class="nc" id="L373">			nstmt.execute();</span>
<span class="nc" id="L374">			nstmt.close();</span>
		}
<span class="nc" id="L376">		connection.close();</span>
<span class="nc" id="L377">		connection = null;</span>
<span class="nc" id="L378">	}</span>
	
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.8.201612092310</span></div></body></html>