<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BookingTextSender.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sample-spring-boot-kitchensink</a> &gt; <a href="index.source.html" class="el_package">com.example.bot.spring.textsender</a> &gt; <span class="el_source">BookingTextSender.java</span></div><h1>BookingTextSender.java</h1><pre class="source lang-java linenums">package com.example.bot.spring.textsender;

import java.util.LinkedList;

import com.example.bot.spring.database.BookingDBEngine;

import lombok.extern.slf4j.Slf4j;
/**
 * handle the book request
 * implement a pipeline model to handle the user input and match it with a good trip
 * @author jsongaf
 *
 */
<span class="nc" id="L14">@Slf4j</span>
public class BookingTextSender implements TextSender {
	
	private BookingDBEngine bookingDB;

<span class="nc" id="L19">	public BookingTextSender() {</span>
<span class="nc" id="L20">		bookingDB = new BookingDBEngine();</span>
<span class="nc" id="L21">	}</span>
	

	@Override
	/** The major processing function
	 * @param userId
	 * @param msg
	 * @return
	 */
	public String process(String userId, String msg) throws Exception {
<span class="nc" id="L31">		bookingDB.openConnection();</span>
<span class="nc" id="L32">		String status = &quot;&quot;;</span>
		try {
<span class="nc" id="L34">			status = bookingDB.getStatus(userId);</span>
<span class="nc" id="L35">		} catch (Exception e1) {</span>
<span class="nc" id="L36">			e1.printStackTrace();</span>
<span class="nc" id="L37">		}</span>
<span class="nc" id="L38">		String reply = &quot;&quot;;</span>
<span class="nc bnc" id="L39" title="All 42 branches missed.">		switch(status) {</span>
			case &quot;double11&quot;:{
<span class="nc bnc" id="L41" title="All 2 branches missed.">				if(bookingDB.detectCancel(msg)) {</span>
<span class="nc" id="L42">					bookingDB.setStatus(&quot;default&quot;, userId);</span>
<span class="nc" id="L43">					reply = this.getInfoQuestion(&quot;cancel&quot;);</span>
<span class="nc" id="L44">					break;</span>
				}
<span class="nc" id="L46">				String name = bookingDB.getName(userId);</span>
<span class="nc bnc" id="L47" title="All 2 branches missed.">				if(name.equals(&quot;&quot;)) {</span>
<span class="nc" id="L48">					reply = getInfoQuestion(&quot;name&quot;);</span>
<span class="nc" id="L49">					bookingDB.setStatus(&quot;name&quot;, userId);</span>
				}else {
<span class="nc" id="L51">					bookingDB.createNewBooking(userId, name);</span>
<span class="nc" id="L52">					bookingDB.setStatus(&quot;adult&quot;, userId);</span>
<span class="nc" id="L53">					reply = this.getInfoQuestion(&quot;adult&quot;);</span>
				}
<span class="nc" id="L55">				break;</span>
			}
			
			case &quot;new&quot;:{
<span class="nc bnc" id="L59" title="All 2 branches missed.">				if(bookingDB.detectPositive(msg)) {</span>
<span class="nc" id="L60">					bookingDB.setStatus(&quot;date&quot;,userId);</span>
<span class="nc" id="L61">					reply = getInfoQuestion(&quot;date&quot;);</span>
				}else {
<span class="nc" id="L63">					bookingDB.setStatus(&quot;default&quot;,userId);</span>
<span class="nc" id="L64">					reply = defaultCaseHandler(userId,msg);</span>
				}
<span class="nc" id="L66">				break;</span>
			}
			
			// Status name: asking for user's actual name
			case &quot;name&quot;:{
<span class="nc" id="L71">				reply = getInfoQuestion(&quot;adult&quot;);</span>
<span class="nc" id="L72">				bookingDB.setStatus(&quot;adult&quot;, userId);</span>
<span class="nc" id="L73">				bookingDB.createNewBooking(userId, msg);</span>
<span class="nc" id="L74">				break;</span>
			}
			
			// Status date: asking for the desired departing date
			case &quot;date&quot;:{
<span class="nc bnc" id="L79" title="All 2 branches missed.">				if(bookingDB.detectCancel(msg)) {</span>
<span class="nc" id="L80">					bookingDB.setStatus(&quot;default&quot;, userId);</span>
<span class="nc" id="L81">					reply = this.getInfoQuestion(&quot;cancel&quot;);</span>
<span class="nc" id="L82">					break;</span>
				}
<span class="nc" id="L84">				String[] s = msg.split(&quot;/&quot;);</span>
<span class="nc bnc" id="L85" title="All 2 branches missed.">				if(s.length != 2) {</span>
<span class="nc" id="L86">					reply = this.getInfoQuestion(&quot;invalid date&quot;);</span>
<span class="nc" id="L87">					break;</span>
				}
				int dd,mm;
				try {
<span class="nc" id="L91">					dd = Integer.parseInt(s[0]);</span>
<span class="nc" id="L92">					mm = Integer.parseInt(s[1]);</span>
<span class="nc" id="L93">				}catch(NumberFormatException e){</span>
<span class="nc" id="L94">					reply = this.getInfoQuestion(&quot;invalid date&quot;);</span>
<span class="nc" id="L95">					break;</span>
<span class="nc" id="L96">				}</span>
				
<span class="nc" id="L98">				boolean valid = false;</span>
				try {
<span class="nc" id="L100">					valid = bookingDB.checkValidDate(dd, mm, userId);</span>
<span class="nc" id="L101">				}catch(Exception e) {</span>
<span class="nc bnc" id="L102" title="All 2 branches missed.">					if(e.getMessage().equals(&quot;FULL&quot;)) {</span>
<span class="nc" id="L103">						reply = this.getInfoQuestion(&quot;fulltour&quot;);</span>
<span class="nc" id="L104">						break;</span>
<span class="nc bnc" id="L105" title="All 2 branches missed.">					}else if(e.getMessage().equals(&quot;NO SUCH DATE&quot;)){</span>
<span class="nc" id="L106">						reply = this.getInfoQuestion(&quot;no such date&quot;);</span>
<span class="nc" id="L107">						break;</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">					}else if(e.getMessage().equals(&quot;OCCUPIED&quot;)) {</span>
<span class="nc" id="L109">						reply = this.getInfoQuestion(&quot;occupied&quot;);</span>
<span class="nc" id="L110">						bookingDB.setStatus(&quot;hold&quot;, userId);</span>
<span class="nc" id="L111">						bookingDB.recordDate(userId, dd, mm);</span>
<span class="nc" id="L112">						break;</span>
<span class="nc bnc" id="L113" title="All 2 branches missed.">					}else if(e.getMessage().equals(&quot;REBOOK&quot;)) {</span>
<span class="nc" id="L114">						reply = this.getInfoQuestion(&quot;no rebook&quot;);</span>
<span class="nc" id="L115">						break;</span>
<span class="nc bnc" id="L116" title="All 2 branches missed.">					}else if(e.getMessage().equals(&quot;CONFIRMED&quot;)) {</span>
<span class="nc" id="L117">						bookingDB.recordDate(userId,dd,mm);</span>
<span class="nc" id="L118">						String name = bookingDB.getName(userId);</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">						if(name.equals(&quot;&quot;)) {</span>
<span class="nc" id="L120">							reply = getInfoQuestion(&quot;name&quot;)+&quot;\nPlease note that the tour you book is already confirmed&quot;;</span>
<span class="nc" id="L121">							bookingDB.setStatus(&quot;name&quot;, userId);</span>
						}else {
<span class="nc" id="L123">							bookingDB.createNewBooking(userId, name);</span>
<span class="nc" id="L124">							bookingDB.setStatus(&quot;adult&quot;, userId);</span>
<span class="nc" id="L125">							reply = this.getInfoQuestion(&quot;adult&quot;);</span>
						}
<span class="nc bnc" id="L127" title="All 2 branches missed.">					}else if(e.getMessage().equals(&quot;CANCELED&quot;)) {</span>
<span class="nc" id="L128">						this.stopCurrentBooking(userId);</span>
<span class="nc" id="L129">						reply = &quot;Sorry. This tour is already canceled. Please book another one.&quot;;</span>
					}
<span class="nc" id="L131">				}</span>
<span class="nc bnc" id="L132" title="All 2 branches missed.">				if(valid) {</span>
<span class="nc" id="L133">					bookingDB.recordDate(userId,dd,mm);</span>
<span class="nc" id="L134">					String name = bookingDB.getName(userId);</span>
<span class="nc bnc" id="L135" title="All 2 branches missed.">					if(name.equals(&quot;&quot;)) {</span>
<span class="nc" id="L136">						reply = getInfoQuestion(&quot;name&quot;);</span>
<span class="nc" id="L137">						bookingDB.setStatus(&quot;name&quot;, userId);</span>
					}else {
<span class="nc" id="L139">						bookingDB.createNewBooking(userId, name);</span>
<span class="nc" id="L140">						bookingDB.setStatus(&quot;adult&quot;, userId);</span>
<span class="nc" id="L141">						reply = this.getInfoQuestion(&quot;adult&quot;);</span>
					}
<span class="nc" id="L143">				}</span>
				break;
			}
			
			// Status adult; asking for number of adults
			case &quot;adult&quot;:{
<span class="nc bnc" id="L149" title="All 2 branches missed.">				if(bookingDB.detectCancel(msg)) {</span>
<span class="nc" id="L150">					this.stopCurrentBooking(userId);</span>
<span class="nc" id="L151">					break;</span>
				}
				try {
<span class="nc" id="L154">					int i = Integer.parseInt(msg);</span>
<span class="nc bnc" id="L155" title="All 2 branches missed.">					if(i&lt;0) {</span>
<span class="nc" id="L156">						reply = this.getInfoQuestion(&quot;invalid adult&quot;);</span>
<span class="nc" id="L157">						break;</span>
					}
<span class="nc" id="L159">					bookingDB.recordAdults(userId,i);</span>
<span class="nc" id="L160">				}catch(NumberFormatException e) {</span>
<span class="nc" id="L161">					reply = this.getInfoQuestion(&quot;invalid adult&quot;);;</span>
<span class="nc" id="L162">					break;</span>
<span class="nc" id="L163">				}</span>
<span class="nc" id="L164">				reply = getInfoQuestion(&quot;children&quot;);</span>
<span class="nc" id="L165">				bookingDB.setStatus(&quot;children&quot;,userId);</span>
<span class="nc" id="L166">				break;</span>
			}
			
			// Status children: asking for number of children (Age 4 to 11)
			case &quot;children&quot;:{
<span class="nc bnc" id="L171" title="All 2 branches missed.">				if(bookingDB.detectCancel(msg)) {</span>
<span class="nc" id="L172">					this.stopCurrentBooking(userId);</span>
<span class="nc" id="L173">					break;</span>
				}
				try {
<span class="nc" id="L176">					int i = Integer.parseInt(msg);</span>
<span class="nc bnc" id="L177" title="All 2 branches missed.">					if(i&lt;0) {</span>
<span class="nc" id="L178">						reply = this.getInfoQuestion(&quot;invalid children&quot;);</span>
<span class="nc" id="L179">						break;</span>
					}
<span class="nc" id="L181">					bookingDB.recordChildren(userId,i);</span>
<span class="nc" id="L182">				}catch(Exception e) {</span>
<span class="nc" id="L183">					reply = this.getInfoQuestion(&quot;invalid children&quot;);</span>
<span class="nc" id="L184">					break;</span>
<span class="nc" id="L185">				}</span>
<span class="nc" id="L186">				reply = getInfoQuestion(&quot;toddler&quot;);</span>
<span class="nc" id="L187">				bookingDB.setStatus(&quot;toddler&quot;,userId);</span>
<span class="nc" id="L188">				break;</span>
			}
			
			//Status toddler: asking for number of children (Age 0 to 3)
			case &quot;toddler&quot;:{
<span class="nc bnc" id="L193" title="All 2 branches missed.">				if(bookingDB.detectCancel(msg)) {</span>
<span class="nc" id="L194">					this.stopCurrentBooking(userId);</span>
<span class="nc" id="L195">					break;</span>
				}
				try {
<span class="nc" id="L198">					int i = Integer.parseInt(msg);</span>
<span class="nc bnc" id="L199" title="All 2 branches missed.">					if(i&lt;0) {</span>
<span class="nc" id="L200">						reply = this.getInfoQuestion(&quot;invalid toddler&quot;);</span>
<span class="nc" id="L201">						break;</span>
					}
<span class="nc" id="L203">					bookingDB.recordToddler(userId,i);</span>
<span class="nc" id="L204">				}catch(Exception e) {</span>
<span class="nc" id="L205">					reply = this.getInfoQuestion(&quot;invalid toddler&quot;);</span>
<span class="nc" id="L206">					break;</span>
<span class="nc" id="L207">				}</span>
<span class="nc" id="L208">				reply = getInfoQuestion(&quot;phone&quot;);</span>
<span class="nc" id="L209">				bookingDB.setStatus(&quot;phone&quot;,userId);</span>
<span class="nc" id="L210">				break;</span>
			}
			
			//Status phone: asking for phone number
			case &quot;phone&quot; :{
<span class="nc bnc" id="L215" title="All 2 branches missed.">				if(bookingDB.detectCancel(msg)) {</span>
<span class="nc" id="L216">					this.stopCurrentBooking(userId);</span>
<span class="nc" id="L217">					break;</span>
				}
				try {
<span class="nc" id="L220">					long i = Long.parseLong(msg);</span>
<span class="nc" id="L221">					bookingDB.recordPhone(userId,i);</span>
<span class="nc" id="L222">				}catch(Exception e) {</span>
<span class="nc" id="L223">					reply = this.getInfoQuestion(&quot;invalid phone&quot;);</span>
<span class="nc" id="L224">					break;</span>
<span class="nc" id="L225">				}</span>
<span class="nc" id="L226">				reply = getTotalPrice(userId);</span>
<span class="nc" id="L227">				break;</span>
			}
			
			// Status confirm: last step before everything finished
			case &quot;confirm&quot; :{
<span class="nc bnc" id="L232" title="All 2 branches missed.">				if(bookingDB.detectPositive(msg)) {</span>
<span class="nc" id="L233">					bookingDB.setStatus(&quot;default&quot;,userId);</span>
<span class="nc" id="L234">					bookingDB.updateRegisteredNumber(userId);</span>
<span class="nc" id="L235">					reply = this.getInfoQuestion(&quot;confirm&quot;);</span>
				}else {
<span class="nc" id="L237">					reply = stopCurrentBooking(userId);</span>
				}
<span class="nc" id="L239">				break;</span>
			}
			case &quot;hold&quot; :{
<span class="nc bnc" id="L242" title="All 2 branches missed.">				if(bookingDB.detectPositive(msg)) {</span>
<span class="nc" id="L243">					String name = bookingDB.getName(userId);</span>
<span class="nc bnc" id="L244" title="All 2 branches missed.">					if(name.equals(&quot;&quot;)) {</span>
<span class="nc" id="L245">						bookingDB.setStatus(&quot;name&quot;, userId);</span>
<span class="nc" id="L246">						reply = this.getInfoQuestion(&quot;name&quot;);</span>
					}else {
<span class="nc" id="L248">						bookingDB.createNewBooking(userId, name);</span>
<span class="nc" id="L249">						bookingDB.setStatus(&quot;adult&quot;, userId);</span>
<span class="nc" id="L250">						reply = this.getInfoQuestion(&quot;adult&quot;);</span>
					}
<span class="nc" id="L252">				}else {</span>
<span class="nc" id="L253">					bookingDB.setStatus(&quot;default&quot;,userId);</span>
<span class="nc" id="L254">					reply = defaultCaseHandler(userId,msg);</span>
				}
<span class="nc" id="L256">				break;</span>
			}
			default:{
<span class="nc" id="L259">				reply = defaultCaseHandler(userId,msg);</span>
			}
		}
<span class="nc" id="L262">		bookingDB.close();</span>
<span class="nc bnc" id="L263" title="All 2 branches missed.">		if(reply.isEmpty()) {</span>
<span class="nc" id="L264">			throw new Exception(&quot;CANNOT ANSWER&quot;);</span>
		}
<span class="nc" id="L266">		return reply;</span>
	}

	/** stop the current booking request of one user
	 * 
	 * @param userId
	 * @return
	 */
	private String stopCurrentBooking(String userId) {
<span class="nc" id="L275">		bookingDB.setStatus(&quot;default&quot;,userId);</span>
<span class="nc" id="L276">		bookingDB.removeBooking(userId);</span>
<span class="nc" id="L277">		return this.getInfoQuestion(&quot;cancel&quot;);</span>
	}

	/** handle a question if the user is not in the booking flow
	 * 
	 * @param userId
	 * @param msg
	 * @return
	 */
	private String defaultCaseHandler(String userId, String msg) {
		// If he specifies the tour ID
<span class="nc" id="L288">		LinkedList&lt;String&gt; tourIds = bookingDB.getAllTourIds();</span>
<span class="nc" id="L289">		String reply = null;</span>
<span class="nc bnc" id="L290" title="All 2 branches missed.">		for(int i = 0; i &lt; tourIds.size(); i++) {</span>
<span class="nc bnc" id="L291" title="All 2 branches missed.">			if(msg.toLowerCase().contains(tourIds.get(i).toLowerCase())) {</span>
<span class="nc" id="L292">				reply = this.getConfirmation(userId, tourIds.get(i));</span>
<span class="nc" id="L293">				return reply;</span>
			}
		}
		
		/*
		// If he specifies the number of the tour
		String[] candiTours = bookingDB.getTourIds(userId);
		String[] orders = {&quot;first&quot;, &quot;second&quot;, &quot;third&quot;, &quot;fourth&quot;, &quot;fifth&quot;, &quot;seventh&quot;, &quot;eighth&quot;, &quot;ninth&quot;, &quot;tenth&quot;, &quot;eleventh&quot;};
		String[] numbers = {&quot;1&quot;, &quot;2&quot;, &quot;3&quot;, &quot;4&quot;, &quot;5&quot;, &quot;6&quot;, &quot;7&quot;, &quot;8&quot;, &quot;9&quot;, &quot;10&quot;, &quot;11&quot;};
		String[] engNumbers = {&quot;one&quot;, &quot;two&quot;, &quot;three&quot;, &quot;four&quot;, &quot;five&quot;, &quot;six&quot;, &quot;seven&quot; ,&quot;eight&quot;, &quot;nine&quot;, &quot;ten&quot;, &quot;eleven&quot;};
		String[] s = msg.split(&quot;\\s&quot;);
		for(int i = 0; i &lt; s.length; i++) {
			for(int j = 0; j &lt; candiTours.length; j++) {
				if(s[i].toLowerCase().equals(orders[j])) {
					reply = this.getConfirmation(userId, tourIds.get(j));
					return reply;
				}else if(s[i].toLowerCase().equals(numbers[j])) {
					reply = this.getConfirmation(userId, tourIds.get(j));
					return reply;
				}else if(s[i].toLowerCase().equals(engNumbers[j])) {
					reply = this.getConfirmation(userId, tourIds.get(j));
					return reply;
				}
			}
		}
		*/
		
		// If he specifies the name of the tour
<span class="nc" id="L321">		LinkedList&lt;String&gt; tourNames = bookingDB.getAllTourNames();</span>
<span class="nc bnc" id="L322" title="All 2 branches missed.">		for(int i = 0; i &lt; tourNames.size(); i++) {</span>
<span class="nc" id="L323">			String[] t = tourNames.get(i).split(&quot;\\s|-&quot;);</span>
<span class="nc bnc" id="L324" title="All 2 branches missed.">			for(int j = 0; j &lt; t.length; j++) {</span>
<span class="nc bnc" id="L325" title="All 2 branches missed.">				if(!msg.toLowerCase().contains(t[j].toLowerCase())) {</span>
<span class="nc" id="L326">					break;</span>
<span class="nc bnc" id="L327" title="All 2 branches missed.">				}else if(j == t.length-1) {</span>
<span class="nc" id="L328">					String tourId = bookingDB.findTourId(tourNames.get(i));</span>
<span class="nc" id="L329">					reply = this.getConfirmation(userId, tourId);</span>
<span class="nc" id="L330">					return reply;</span>
				}
			}
		}
		
<span class="nc bnc" id="L335" title="All 2 branches missed.">		if(bookingDB.detectAsk(msg)) {</span>
<span class="nc" id="L336">			reply = this.getInfoQuestion(&quot;asking&quot;);</span>
<span class="nc" id="L337">			return reply;</span>
		}
<span class="nc bnc" id="L339" title="All 2 branches missed.">		if(bookingDB.detectCancel(msg))</span>
<span class="nc" id="L340">			reply = this.getInfoQuestion(&quot;cancel&quot;);</span>
<span class="nc" id="L341">		return reply;</span>
	}

	/** calculate the total price of the current booking request for one user
	 * 
	 * @param userId
	 * @return
	 */
	private String getTotalPrice(String userId) {
<span class="nc" id="L350">		int adult = bookingDB.getAdult(userId);</span>
<span class="nc" id="L351">		int toodler = bookingDB.getToddler(userId);</span>
<span class="nc" id="L352">		int children = bookingDB.getChildren(userId);</span>
<span class="nc" id="L353">		String tourId = bookingDB.getTourIds(userId)[0];</span>
<span class="nc" id="L354">		int quota = bookingDB.getQuota(tourId);</span>
<span class="nc" id="L355">		String discount = bookingDB.checkDiscount(userId);</span>
<span class="nc bnc" id="L356" title="All 2 branches missed.">		if(quota &lt; (adult+toodler+children)) {</span>
<span class="nc" id="L357">			String reply = String.format(this.getInfoQuestion(&quot;no quota&quot;), quota, tourId);</span>
<span class="nc" id="L358">			bookingDB.setStatus(&quot;default&quot;,userId);</span>
<span class="nc" id="L359">			bookingDB.removeBooking(userId);</span>
<span class="nc" id="L360">			return reply;</span>
<span class="nc bnc" id="L361" title="All 2 branches missed.">		}else if(discount.equals(&quot;true&quot;)) {</span>
<span class="nc" id="L362">			String reply = &quot;&quot;;</span>
<span class="nc" id="L363">			int disAdult = 0;</span>
<span class="nc" id="L364">			int disChildren = 0;</span>
<span class="nc bnc" id="L365" title="All 2 branches missed.">			if(adult+children+toodler &gt; 2) {</span>
<span class="nc" id="L366">				reply = this.getInfoQuestion(&quot;double11 error&quot;);</span>
<span class="nc bnc" id="L367" title="All 2 branches missed.">				if(adult&gt;=2) {</span>
<span class="nc" id="L368">					disAdult = 2;</span>
<span class="nc bnc" id="L369" title="All 2 branches missed.">				}else if(children &gt;= 2-adult) {</span>
<span class="nc" id="L370">					disAdult = adult;</span>
<span class="nc" id="L371">					disChildren = 2-disAdult;</span>
				}
			}else {
<span class="nc" id="L374">				disAdult = adult;</span>
<span class="nc" id="L375">				disChildren = children;</span>
			}
<span class="nc" id="L377">			double price = bookingDB.getPrice(tourId);</span>
<span class="nc" id="L378">			double totalPrice = price*0.5*disAdult+price*0.8*0.5*disChildren</span>
					+price*(adult-disAdult)+price*0.8*(children-disChildren);
<span class="nc" id="L380">			reply = reply + String.format(this.getInfoQuestion(&quot;price&quot;), totalPrice);</span>
<span class="nc" id="L381">			bookingDB.recordTotalPrice(totalPrice,userId);</span>
<span class="nc" id="L382">			bookingDB.setStatus(&quot;confirm&quot;,userId);</span>
<span class="nc" id="L383">			bookingDB.setDiscount(&quot;false&quot;,userId);</span>
<span class="nc" id="L384">			return reply;</span>
		}else {
<span class="nc" id="L386">			double price = bookingDB.getPrice(tourId);</span>
<span class="nc" id="L387">			double totalPrice = price*adult+price*0.8*children;</span>
<span class="nc" id="L388">			String reply = String.format(this.getInfoQuestion(&quot;price&quot;), totalPrice);</span>
<span class="nc" id="L389">			bookingDB.recordTotalPrice(totalPrice,userId);</span>
<span class="nc" id="L390">			bookingDB.setStatus(&quot;confirm&quot;,userId);</span>
<span class="nc" id="L391">			return reply;</span>
		}
	}
	
	/** Get the confirmation message of one tour before start a booking request
	 * 
	 * @param tourId
	 * @return
	 */
	private String getConfirmation(String userId, String tourId) {
<span class="nc" id="L401">		LinkedList&lt;String&gt; tourInfo = bookingDB.getTourInfos(tourId);</span>
<span class="nc" id="L402">		String dates = bookingDB.getAllDates(tourId);</span>
<span class="nc" id="L403">		StringBuilder sb = new StringBuilder();</span>
<span class="nc" id="L404">		String[] allDates = dates.split(&quot;,&quot;);</span>
<span class="nc bnc" id="L405" title="All 2 branches missed.">		for(int i = 0; i &lt; allDates.length; i++) {</span>
<span class="nc bnc" id="L406" title="All 4 branches missed.">			if(i == allDates.length-1 &amp;&amp; i != 0)</span>
<span class="nc" id="L407">				sb.append(&quot; and &quot;);</span>
<span class="nc bnc" id="L408" title="All 2 branches missed.">			else if(i != 0)</span>
<span class="nc" id="L409">				sb.append(&quot;, &quot;);</span>
<span class="nc" id="L410">			sb.append(allDates[i].substring(2)+&quot;/&quot;+allDates[i].substring(0,2));</span>
		}
<span class="nc" id="L412">		String dateSeg = sb.toString();</span>
<span class="nc" id="L413">		String reply = this.getInfoQuestion(&quot;allinfo&quot;);</span>
<span class="nc" id="L414">		bookingDB.setTourid(userId, tourId);</span>
<span class="nc" id="L415">		bookingDB.setStatus(&quot;new&quot;, userId);</span>
<span class="nc" id="L416">		return String.format(reply, tourId, tourInfo.get(0), tourInfo.get(1), </span>
<span class="nc" id="L417">				dateSeg, tourInfo.get(2), tourInfo.get(3));</span>
	}
	/*

	*/


	/** Return next question according to tag
	 * 
	 * @param nextQ
	 * @return
	 */
	private String getInfoQuestion(String nextQ) {
<span class="nc" id="L430">		String reply = bookingDB.getReplyMessage(nextQ);</span>
<span class="nc" id="L431">		return reply;</span>
	}
	
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.8.201612092310</span></div></body></html>