<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TextProcessor.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sample-spring-boot-kitchensink</a> &gt; <a href="index.source.html" class="el_package">com.example.bot.spring</a> &gt; <span class="el_source">TextProcessor.java</span></div><h1>TextProcessor.java</h1><pre class="source lang-java linenums">package com.example.bot.spring;

import com.example.bot.spring.database.DBEngine;
import com.example.bot.spring.database.DoubleElevDBEngine;
import com.example.bot.spring.textsender.*;
/**
 * process all the user input and categorize the information
 * @author jsongaf
 *
 */
<span class="pc bpc" id="L11" title="1 of 2 branches missed.">public class TextProcessor {</span>

	private DBEngine DBE;
	private DoubleElevDBEngine DEDBE; 
	
<span class="fc" id="L16">	public TextProcessor() {</span>
		// TODO Auto-generated constructor stub
<span class="fc" id="L18">		DBE=new DBEngine();</span>
<span class="fc" id="L19">		DEDBE = new DoubleElevDBEngine();</span>
<span class="fc" id="L20">	}</span>
	
	/**
	 * classify the user input and see what kind of request the user is asking
	 * @param userId
	 * @param text
	 * @return
	 * @throws Exception
	 */
	private String classifyText(String userId, String text) throws Exception{
<span class="fc" id="L30">		String reply=&quot;&quot;;		</span>
		
		try {			
<span class="fc" id="L33">			String tag = DBE.getLineUserInfo(userId,&quot;categorization&quot;); // from database; </span>
<span class="fc" id="L34">			String label = DBE.getTextType(text);					   // by analysis input </span>
						
<span class="fc" id="L36">			SQTextSender sqsender = new SQTextSender();</span>
<span class="fc" id="L37">			reply = sqsender.process(userId, text);</span>
<span class="fc bfc" id="L38" title="All 2 branches covered.">			if(!reply.isEmpty())</span>
<span class="fc" id="L39">				reply += &quot;\n&quot;;</span>
			
<span class="pc bpc" id="L41" title="1 of 2 branches missed.">			if(tag.equals(&quot;book&quot;)) {</span>
<span class="nc" id="L42">				BookingTextSender bsender = new BookingTextSender();</span>
<span class="nc" id="L43">				reply += bsender.process(userId, text);	</span>
<span class="nc" id="L44">				return reply;</span>
			}
			
<span class="fc" id="L47">			System.out.println(text.charAt(0));</span>
<span class="fc" id="L48">			System.out.println(text.charAt(text.length()-1));</span>
<span class="fc" id="L49">			System.out.println(text);</span>
<span class="pc bpc" id="L50" title="2 of 4 branches missed.">			if (text.toLowerCase().equals(&quot;yes&quot;)|| text.toLowerCase().equals(&quot;no&quot;)) {</span>
<span class="nc" id="L51">				System.out.println(&quot;We should handle double 11&quot;);</span>
<span class="nc" id="L52">				return double_elev_handler(userId, text);</span>
			}
			
			// after decide the label:
			// - update user tag;
			// - pass the info to corresponding text processor;			
<span class="pc bpc" id="L58" title="9 of 14 branches missed.">			switch (label) {</span>
			case &quot;reco&quot;: 
<span class="nc" id="L60">				RecommendationTextSender rsender = new RecommendationTextSender();</span>
<span class="nc" id="L61">				DBE.updateLineUserInfo(userId,&quot;categorization&quot;,&quot;reco&quot;);	</span>
<span class="nc" id="L62">				reply += rsender.process(userId, text);			</span>
<span class="nc" id="L63">				return reply;</span>
				
			case &quot;gq&quot;:
<span class="fc" id="L66">				GQTextSender gqsender = new GQTextSender();</span>
<span class="fc" id="L67">				DBE.updateLineUserInfo(userId,&quot;categorization&quot;, &quot;gq&quot;);	</span>
<span class="fc" id="L68">				reply += gqsender.process(userId, text);			</span>
<span class="fc" id="L69">				return reply;</span>
				
			case &quot;book&quot;:
<span class="nc" id="L72">				BookingTextSender bsender = new BookingTextSender();</span>
<span class="nc" id="L73">				DBE.updateLineUserInfo(userId,&quot;categorization&quot;,&quot;book&quot;);	</span>
<span class="nc" id="L74">				reply += bsender.process(userId, text);			</span>
<span class="nc" id="L75">				return reply;</span>
				
			default:
				// no action, continue to next checking state; 				
			}
			
<span class="pc bpc" id="L81" title="5 of 10 branches missed.">			switch (tag) {</span>
			case &quot;reco&quot;:
<span class="nc" id="L83">				RecommendationTextSender rsender = new RecommendationTextSender();</span>
<span class="nc" id="L84">				reply += rsender.process(userId, text);	</span>
<span class="nc" id="L85">				return reply;</span>
			case &quot;gq&quot;:
<span class="fc" id="L87">				GQTextSender gqsender = new GQTextSender();</span>
<span class="nc" id="L88">				reply += gqsender.process(userId, text);	</span>
<span class="nc" id="L89">				return reply;</span>
			default:
				// no action, continue to unanswered question processor; 
			}
			
<span class="fc" id="L94">			reply += &quot;You can send your request by specifying: recommendation/ general question/booking a trip&quot;;</span>
<span class="fc" id="L95">			UQAutomateSender uqSender = new UQAutomateSender();</span>
<span class="fc" id="L96">			uqSender.process(userId, text);	</span>
<span class="pc bpc" id="L97" title="1 of 2 branches missed.">			if(reply.equals(&quot;&quot;)) throw new Exception();</span>
<span class="fc" id="L98">			return reply;</span>
<span class="fc" id="L99">		} catch (Exception e) {</span>
<span class="fc" id="L100">			e.printStackTrace();</span>
			try {
<span class="fc" id="L102">				DBE.updateLineUserInfo(userId,&quot;categorization&quot;, &quot;default&quot;);</span>
<span class="nc" id="L103">			}catch(Exception e2) {</span>
				// no action; 
<span class="fc" id="L105">			}	</span>
			
<span class="fc" id="L107">			UQAutomateSender uqSender = new UQAutomateSender();			</span>
<span class="fc" id="L108">			reply += uqSender.process(userId, text);			</span>
			
<span class="fc" id="L110">			return reply; //return &quot;exception here&quot;;</span>
		}

	}
	/**
	 * process the text and extract the key words from it
	 * @param userId
	 * @param text
	 * @return
	 * @throws Exception
	 */
	public String processText(String userId, String text) throws Exception{
<span class="pc bpc" id="L122" title="1 of 2 branches missed.">		if (text == null) {// yet text won't be null?</span>
<span class="nc" id="L123">			throw new Exception(&quot;no input&quot;);</span>
		}
<span class="fc" id="L125">		String reply = &quot;&quot;;		</span>
		
<span class="fc" id="L127">		text = formatMsg(text);	// format the text before classification </span>
<span class="fc" id="L128">		DBE.updateLineUserInfo(userId,&quot;lastq&quot;,text); // insert the formatted text into database; </span>
		
<span class="fc bfc" id="L130" title="All 2 branches covered.">		if(text.equals(&quot;&quot;)) {</span>
<span class="fc" id="L131">			throw new Exception(&quot;no input&quot;);</span>
		}else {
<span class="fc" id="L133">			reply = classifyText(userId,text);</span>
<span class="fc" id="L134">			DBE.updateLineUserInfo(userId,&quot;lasta&quot;,reply);</span>
<span class="fc" id="L135">			return reply;</span>
		}
	}
	


	/**
	 * truncate all non-digit and non-char elements from user input (decimal point is reserved)
	 * and transform the input into lower case; 
	 * it's possible for formatMsg() to return a empty text, which need to be handled in its calling function
	 * @param message
	 * @return
	 */
	private String formatMsg(String message) {
<span class="fc" id="L149">		char preChar = 'S';</span>
<span class="fc" id="L150">		String outputMsg = &quot;&quot;;</span>
		
<span class="fc bfc" id="L152" title="All 2 branches covered.">		for (char c: message.toCharArray()) {</span>
<span class="pc bpc" id="L153" title="1 of 6 branches missed.">			if(isDigit(c) || isChar(c) || isAllowedPunc(c)){</span>
<span class="fc" id="L154">				outputMsg += c;</span>
<span class="fc" id="L155">				preChar = c;</span>
<span class="pc bpc" id="L156" title="1 of 2 branches missed.">			}else if (preChar != ' '){</span>
<span class="fc" id="L157">				outputMsg += ' ';</span>
<span class="fc" id="L158">				preChar = ' ';</span>
			}
		}
<span class="fc" id="L161">		outputMsg = outputMsg.toLowerCase();	</span>
<span class="fc" id="L162">		return outputMsg;</span>
	}

	/**
	 * helper function for formatMsg()
	 * check if next character is 'char'
	 * @param c
	 * @return
	 */
	private boolean isChar (char c) {
<span class="pc bpc" id="L172" title="2 of 8 branches missed.">		if ((c &gt;= 'a' &amp;&amp; c &lt;= 'z') || (c &gt;= 'A' &amp;&amp; c &lt;= 'Z'))</span>
<span class="fc" id="L173">			return true;</span>
		else
<span class="fc" id="L175">			return false; </span>
	}
	
	/**
	 * helper function for formatMsg()
	 * check if next character is 0-9 or decimal point
	 * @param c
	 * @return
	 */
	private boolean isDigit (char c) {
<span class="fc bfc" id="L185" title="All 6 branches covered.">		if ((c &gt;= '0' &amp;&amp; c &lt;= '9') || c == '.')</span>
<span class="fc" id="L186">			return true;</span>
		else
<span class="fc" id="L188">			return false; </span>
	}
	
	/**
	 * helper function for formatMsg()
	 * check if next character is legal puncuation
	 * @param c
	 * @return
	 */
	private boolean isAllowedPunc(char c) {
<span class="pc bpc" id="L198" title="1 of 2 branches missed.">		if ( c == '/')</span>
<span class="nc" id="L199">			return true;</span>
		else
<span class="fc" id="L201">			return false; </span>
	}

	/** special handler for double 11 event; 
	 * after a double11 message is broadcast, check user reply;
	 * if reply yes:
	 * @param userId
	 * @param message
	 * @return
	 * @throws Exception
	 */
	private String double_elev_handler(String userId, String message) throws Exception {
<span class="nc bnc" id="L213" title="All 6 branches missed.">		assert (message.equals(&quot;yes&quot;)|| message.equals(&quot;no&quot;));</span>
<span class="nc" id="L214">		String reply = &quot;&quot;;</span>
<span class="nc bnc" id="L215" title="All 2 branches missed.">		if (message.equals(&quot;yes&quot;)) {</span>
			// get current discount tour
<span class="nc" id="L217">			String discount_tourid = DEDBE.getDiscountBookid(&quot;sent&quot;); 					// check double11 table, get available tour's id; id =  DEDBE.getDiscountBookid()	</span>
<span class="nc" id="L218">			System.out.println(discount_tourid);</span>
			// check if there are still ticket:
<span class="nc bnc" id="L220" title="All 2 branches missed.">			if(DEDBE.ifTourFull(discount_tourid)) {</span>
<span class="nc" id="L221">				DBE.updateLineUserInfo(userId,&quot;categorization&quot;, &quot;book&quot;); 			// update line_user_info.categorization into &quot;booking&quot;	</span>
<span class="nc" id="L222">				DBE.updateLineUserInfo(userId,&quot;status&quot;, &quot;double11&quot;); 			// update line_user_info.categorization into &quot;booking&quot;	</span>
<span class="nc" id="L223">				DBE.updateLineUserInfo(userId,&quot;tourids&quot;, discount_tourid); 	// update line_user_info.discount_tour_id = id;</span>
<span class="nc" id="L224">				DBE.updateLineUserInfo(userId,&quot;discount&quot;, &quot;true&quot;); 	// update line_user_info.discount_tour_id = id;</span>
<span class="nc" id="L225">				DEDBE.updateQuota(discount_tourid);</span>
<span class="nc" id="L226">				reply = &quot;Congratulations! You Got A Discount Ticket! Now you can continue booking!&quot;;</span>
			}else {
<span class="nc" id="L228">				reply = &quot;Sorry ticket sold out&quot;;</span>
			}
<span class="nc" id="L230">		}</span>
		else {
<span class="nc" id="L232">			reply = &quot;Sure =) Have a nice days.&quot;; </span>
		}
		
<span class="nc" id="L235">		return reply;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.8.201612092310</span></div></body></html>